<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Financial Dashboard</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    
    <!-- Google Fonts for typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .drop-zone {
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
        }
        .drop-zone--over {
            background-color: #e0e7ff;
            border-color: #4f46e5;
        }
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #4f46e5;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .chart-container {
            position: relative;
            height: 350px;
            width: 100%;
        }
        .detailed-chart-container {
            position: relative;
            width: 100%;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
            height: 800px;
        }
         .product-range-chart-container {
            position: relative;
            width: 100%;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
            height: 1200px;
        }
        .tab-btn {
            transition: all 0.3s ease-in-out;
            border-bottom-width: 2px;
            border-color: transparent;
        }
        .tab-btn.active {
            border-color: #4f46e5; 
            color: #4f46e5; 
            font-weight: 600;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .kpi-progress-indicator::before {
            content: ''; position: absolute; top: -4px; bottom: -4px; width: 3px; 
            background-color: #4b5563; border-radius: 1.5px; z-index: 5; 
        }

        /* Chatbot Styles */
        #chatbot-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
        #chatbot-toggle {
            background-color: #4f46e5;
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transition: transform 0.2s;
        }
        #chatbot-toggle:hover {
            transform: scale(1.1);
        }
        #chatbot-window {
            position: absolute;
            bottom: 80px;
            right: 0;
            width: 350px;
            height: 450px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transform-origin: bottom right;
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
        }
        #chat-messages {
            flex-grow: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .chat-message {
            padding: 8px 12px;
            border-radius: 18px;
            max-width: 80%;
        }
        .user-message {
            background-color: #4f46e5;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }
        .bot-message {
            background-color: #eef2ff;
            color: #374151;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }
        #chat-input-container {
            border-top: 1px solid #e5e7eb;
            padding: 10px;
            display: flex;
        }
        #chat-input {
            flex-grow: 1;
            border: 1px solid #d1d5db;
            border-radius: 20px;
            padding: 8px 15px;
            outline: none;
        }
        #chat-send {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0 10px;
            color: #4f46e5;
        }
    </style>
</head>
<body class="text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-900">Dynamic Financial Dashboard</h1>
            <p class="text-lg text-gray-600 mt-2">Your live financial analysis tool, powered by AI.</p>
        </header>

        <main id="app" class="space-y-8">

            <section id="controls-section" class="flex justify-between items-center">
                <div class="flex items-center space-x-2 bg-white p-1 rounded-lg shadow">
                    <button id="view-ytd-btn" class="px-4 py-2 text-sm font-semibold rounded-md transition-colors">YTD</button>
                    <button id="view-all-btn" class="px-4 py-2 text-sm font-semibold rounded-md transition-colors">All Time</button>
                </div>
                <button id="add-data-button" class="bg-indigo-600 text-white font-bold py-2 px-5 rounded-lg hover:bg-indigo-700 transition-colors duration-200">
                    Add/Update Financials
                </button>
            </section>
            
            <section id="upload-section" class="hidden bg-white p-6 rounded-2xl shadow-lg border border-gray-200">
                <h2 class="text-2xl font-semibold mb-4 text-gray-800">Upload Latest Financials</h2>
                <div id="drop-zone" class="drop-zone mt-4 border-4 border-dashed border-gray-300 rounded-xl p-8 text-center cursor-pointer">
                    <input type="file" id="file-input" multiple class="hidden">
                    <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
                        <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                    <p class="mt-4 text-lg text-gray-600">
                        <span class="font-semibold text-indigo-600">Click to upload</span> or drag and drop your PDFs here.
                    </p>
                    <p class="text-xs text-gray-500 mt-2">Upload Income Statement, Balance Sheet, and/or Shipments by Product reports.</p>
                </div>
                <div id="file-list" class="mt-4 text-sm text-gray-700"></div>
                <button id="analyze-button" class="mt-6 w-full bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-indigo-700 disabled:bg-gray-400 transition-colors duration-200">
                    Analyze & Update Dashboard
                </button>
            </section>

            <section id="status-section" class="hidden text-center p-6 bg-white rounded-2xl shadow-lg border border-gray-200">
                <div id="loader" class="loader mx-auto"></div>
                <p id="status-text" class="mt-4 text-lg font-medium text-gray-700">Initializing...</p>
            </section>
            
            <section id="error-section" class="hidden p-6 bg-red-50 text-red-700 rounded-2xl shadow-lg border border-red-200">
                 <h2 class="text-2xl font-semibold mb-2 text-red-800">An Error Occurred</h2>
                 <p id="error-text" class="whitespace-pre-line"></p>
            </section>

            <section id="dashboard-section" class="hidden space-y-8">
                <h2 id="dashboard-title" class="text-2xl font-semibold text-gray-800">Dashboard & Analysis</h2>

                <section id="general-health-indicators">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Overall Health Status</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div id="current-month-health-card" class="bg-white p-6 rounded-xl shadow-lg border">
                            <h4 class="text-lg font-semibold text-gray-700 mb-3">Latest Month Health (<span id="latest-month-label"></span>)</h4>
                            <div class="flex items-center mb-3">
                                <span id="current-month-health-indicator" class="w-8 h-8 rounded-full mr-4"></span>
                                <p id="current-month-health-text" class="text-xl text-gray-800 font-semibold"></p>
                            </div>
                            <div class="text-xs space-y-1">
                                <p class="text-gray-600">Profit vs Avg. Monthly Target: <span id="current-month-profit-status" class="font-medium"></span></p>
                                <p class="text-gray-600">Profit Margin vs Target: <span id="current-month-margin-status" class="font-medium"></span></p>
                                <p class="text-gray-600">Material Costs % of Sales vs Target: <span id="current-month-material-cost-status" class="font-medium"></span></p>
                            </div>
                        </div>
                        <div id="ytd-health-card" class="bg-white p-6 rounded-xl shadow-lg border">
                            <h4 class="text-lg font-semibold text-gray-700 mb-3">Financial YTD Health</h4>
                            <div class="flex items-center mb-3">
                                <span id="ytd-health-indicator" class="w-8 h-8 rounded-full mr-4"></span>
                                <p id="ytd-health-text" class="text-xl text-gray-800 font-semibold"></p>
                            </div>
                             <div class="text-xs space-y-1">
                                <p class="text-gray-600">YTD Profit Margin: <span id="ytd-margin-status" class="font-medium"></span></p>
                                <p class="text-gray-600">YTD Material Costs % of Sales: <span id="ytd-material-cost-status" class="font-medium"></span></p>
                            </div>
                        </div>
                    </div>
                </section>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200 flex flex-col justify-between">
                        <div>
                            <h3 class="text-base font-medium text-gray-500">Progress to Annual Target</h3>
                            <p id="kpi-ytd-profit" class="text-3xl font-semibold text-gray-900 mt-2">R0.00</p>
                        </div>
                        <div class="mt-4">
                            <div class="flex justify-between text-sm text-gray-600 mb-1"><span>Progress</span><span id="progress-percentage" class="font-semibold text-indigo-600">0%</span></div>
                            <div class="w-full bg-gray-200 rounded-full h-3 relative"><div id="progress-bar" class="bg-indigo-600 h-3 rounded-full" style="width: 0%"></div></div>
                            <p class="text-xs text-right text-gray-500 mt-1">Target: <span id="kpi-target-profit">R0.00</span></p>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200 flex flex-col justify-between">
                        <div>
                             <h3 id="kpi-margin-title" class="text-base font-medium text-gray-500">YTD Profit Margin</h3>
                            <p id="kpi-ytd-margin" class="text-3xl font-semibold text-gray-900 mt-2">0.00%</p>
                        </div>
                         <div class="mt-4">
                            <div class="flex justify-between text-sm text-gray-600 mb-1"><span>Performance</span><span id="margin-indicator" class="font-semibold"></span></div>
                             <div class="w-full bg-gray-200 rounded-full h-3 relative"><div id="margin-bar" class="h-3 rounded-full" style="width: 0%"></div><div id="margin-target-line" class="kpi-progress-indicator" style="left: 0%;"></div></div>
                            <p class="text-xs text-right text-gray-500 mt-1">Target: <span id="kpi-margin-target">0.00%</span> (vertical line)</p>
                        </div>
                    </div>
                     <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200 flex flex-col justify-between">
                        <div>
                            <h3 id="kpi-material-cost-title" class="text-base font-medium text-gray-500">YTD Material Costs %</h3>
                            <p id="kpi-material-cost-percentage" class="text-3xl font-semibold text-gray-900 mt-2">0.00%</p>
                        </div>
                        <div class="mt-4">
                            <div class="flex justify-between text-sm text-gray-600 mb-1"><span>Performance</span><span id="material-cost-indicator" class="font-semibold"></span></div>
                             <div class="w-full bg-gray-200 rounded-full h-3 relative"><div id="material-cost-bar" class="h-3 rounded-full" style="width: 0%"></div><div id="material-cost-target-line" class="kpi-progress-indicator" style="left: 0%;"></div></div>
                            <p class="text-xs text-right text-gray-500 mt-1">Target: <span id="kpi-material-cost-target">0.00%</span> (vertical line)</p>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200">
                        <h3 class="text-base font-medium text-gray-500">Projected Annual Profit</h3>
                        <p id="kpi-projected-profit" class="text-3xl font-semibold text-gray-900 mt-2">R0.00</p>
                        <hr class="my-4 border-gray-200">
                        <h3 class="text-base font-medium text-gray-500">Current Ratio</h3>
                        <p id="kpi-current-ratio" class="text-3xl font-semibold text-gray-900 mt-1">0.00</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800">Monthly Net Profit Trend</h3>
                        <div class="chart-container">
                            <canvas id="netProfitChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200">
                         <h3 class="text-xl font-semibold mb-4 text-gray-800">Monthly Revenue vs. Costs</h3>
                        <div class="chart-container">
                            <canvas id="revenueVsCostChart"></canvas>
                        </div>
                    </div>
                </div>

                <section id="analysis-section" class="bg-white p-4 sm:p-6 rounded-xl shadow-lg border border-gray-200">
                    <div class="border-b border-gray-300">
                        <nav id="tabs" class="-mb-px flex space-x-1 sm:space-x-4 overflow-x-auto pb-px" aria-label="Tabs">
                            <button data-target="product_performance" class="tab-btn whitespace-nowrap py-3 px-2 sm:px-4 font-medium text-sm text-gray-500 hover:text-indigo-600 active">Product Performance</button>
                            <button data-target="cost_structure" class="tab-btn whitespace-nowrap py-3 px-2 sm:px-4 font-medium text-sm text-gray-500 hover:text-indigo-600">Overall Costs</button>
                            <button data-target="detailed_cos" class="tab-btn whitespace-nowrap py-3 px-2 sm:px-4 font-medium text-sm text-gray-500 hover:text-indigo-600">Cost of Sales Details</button>
                            <button data-target="detailed_opex" class="tab-btn whitespace-nowrap py-3 px-2 sm:px-4 font-medium text-sm text-gray-500 hover:text-indigo-600">Other Expenses Details</button>
                        </nav>
                    </div>
                    <div class="pt-6">
                        <div id="content-product_performance" class="tab-content active">
                            <h3 class="text-xl font-semibold mb-1 text-gray-800">Product Performance (Cost % of Sales)</h3>
                            <p class="text-gray-600 mb-6 text-sm">Cost of Sales as a percentage of Total Sales for each product range. Target is 53% (lower is better).</p>
                             <div class="product-range-chart-container"><canvas id="productRangeChart"></canvas></div>
                        </div>
                        <div id="content-cost_structure" class="tab-content">
                            <h3 class="text-xl font-semibold mb-1 text-gray-800">YTD Overall Cost Structure</h3>
                            <p class="text-gray-600 mb-6 text-sm">High-level breakdown of Year-to-Date total costs.</p>
                             <div class="chart-container" style="max-width: 450px; height: 350px; margin: auto;"><canvas id="overallCostStructureChart"></canvas></div>
                        </div>
                        <div id="content-detailed_cos" class="tab-content">
                            <h3 class="text-xl font-semibold mb-1 text-gray-800">YTD Detailed Cost of Sales Breakdown</h3>
                            <p class="text-gray-600 mb-6 text-sm">Granular view of the "Cost of Sales" category.</p>
                             <div class="detailed-chart-container"><canvas id="detailedCostOfSalesChart"></canvas></div>
                        </div>
                        <div id="content-detailed_opex" class="tab-content">
                            <h3 class="text-xl font-semibold mb-1 text-gray-800">YTD Detailed Other Expenses Breakdown</h3>
                            <p class="text-gray-600 mb-6 text-sm">Granular view of the "Other Expenses" category.</p>
                             <div class="detailed-chart-container"><canvas id="detailedOtherExpensesChart"></canvas></div>
                        </div>
                    </div>
                </section>

                <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200">
                    <h3 class="text-xl font-semibold text-gray-800">Gemini 2.5 Pro Analysis</h3>
                    <div id="ai-analysis" class="mt-4 prose prose-indigo max-w-none text-gray-700 whitespace-pre-line">
                        <p>Analysis will appear here...</p>
                    </div>
                </div>
            </section>
        </main>
        
        <footer class="text-center mt-12 py-4 border-t border-gray-300">
            <p class="text-sm text-gray-500">Powered by Gemini 2.5 Pro & Firebase</p>
        </footer>

        <!-- Chatbot UI -->
        <div id="chatbot-container">
            <div id="chatbot-window" class="hidden scale-0 opacity-0">
                <div class="p-4 bg-indigo-600 text-white font-semibold">Financial Assistant</div>
                <div id="chat-messages">
                    <div class="chat-message bot-message">Hello! How can I help you analyze the financial data?</div>
                </div>
                <div id="chat-input-container">
                    <input type="text" id="chat-input" placeholder="Ask a question...">
                    <button id="chat-send">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" /></svg>
                    </button>
                </div>
            </div>
            <button id="chatbot-toggle">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" /></svg>
            </button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- DOM ELEMENT REFERENCES ---
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const fileList = document.getElementById('file-list');
        const analyzeButton = document.getElementById('analyze-button');
        const statusSection = document.getElementById('status-section');
        const loader = document.getElementById('loader');
        const statusText = document.getElementById('status-text');
        const dashboardSection = document.getElementById('dashboard-section');
        const errorSection = document.getElementById('error-section');
        const errorText = document.getElementById('error-text');
        const addDataButton = document.getElementById('add-data-button');
        const uploadSection = document.getElementById('upload-section');
        const tabsContainer = document.getElementById('tabs');
        const viewYtdBtn = document.getElementById('view-ytd-btn');
        const viewAllBtn = document.getElementById('view-all-btn');
        const dashboardTitle = document.getElementById('dashboard-title');
        const chatbotToggle = document.getElementById('chatbot-toggle');
        const chatbotWindow = document.getElementById('chatbot-window');
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const chatSend = document.getElementById('chat-send');

        // --- STATE MANAGEMENT ---
        let uploadedFiles = [];
        let db, auth;
        let chartInstances = {};
        let currentData = null;
        let currentViewMode = 'ytd';
        
        // --- FINANCIAL TARGETS & HISTORICAL DATA ---
        const targets = { 
            annualProfit: 25475359.75, 
            profitMargin: 10.11,
            materialCostPercentage: 53.00
        };
        const historicalAnnualData = {
            fy2022: { netProfit: 14318675.49 },
            fy2023: { netProfit: 8624848.47 },
            fy2024: { netProfit: 11013788.22 },
            fy2025: { netProfit: 13793668.42 },
        };
        
        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyBnOemVRN1BeLJsu3Eys8ZQdttyex9h3Gc",
            authDomain: "dashboard-e830a.firebaseapp.com",
            projectId: "dashboard-e830a",
            storageBucket: "dashboard-e830a.appspot.com",
            messagingSenderId: "637034789575",
            appId: "1:637034789575:web:09e0041d43ea411c851ce2",
            measurementId: "G-3QZ1FPH8DF"
        };
        const appId = firebaseConfig.appId;

        // --- INITIALIZATION ---
        async function initialize() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        statusText.textContent = 'Authenticated. Checking for saved data...';
                        setupRealtimeListener();
                    }
                });
                statusText.textContent = 'Authenticating...';
                await signInAnonymously(auth);
            } catch (e) {
                console.error("Firebase initialization error:", e);
                if (e.code === "auth/configuration-not-found") {
                    const errorMessage = `Firebase Authentication Error: Anonymous Sign-In is not enabled for your project. 
                    \nTo fix this:\n1. Go to your Firebase Console.\n2. Navigate to Build -> Authentication.\n3. Click the 'Sign-in method' tab.\n4. Click on 'Anonymous' and enable it.`;
                    showError(errorMessage);
                } else {
                    showError(`Could not initialize the application: ${e.message}`);
                }
            }
        }

        // --- UI EVENT HANDLERS ---
        function setupUIHandlers() {
            dropZone.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', () => handleFiles(fileInput.files));
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => dropZone.addEventListener(e, preventDefaults, false));
            ['dragenter', 'dragover'].forEach(e => dropZone.addEventListener(e, () => dropZone.classList.add('drop-zone--over'), false));
            ['dragleave', 'drop'].forEach(e => dropZone.addEventListener(e, () => dropZone.classList.remove('drop-zone--over'), false));
            dropZone.addEventListener('drop', (e) => handleFiles(e.dataTransfer.files), false);
            
            analyzeButton.addEventListener('click', processFiles);
            addDataButton.addEventListener('click', () => uploadSection.classList.toggle('hidden'));
            
            tabsContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('tab-btn')) {
                    tabsContainer.querySelectorAll('.tab-btn').forEach(tab => tab.classList.remove('active'));
                    e.target.classList.add('active');
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                    document.getElementById(`content-${e.target.dataset.target}`).classList.add('active');
                }
            });

            viewYtdBtn.addEventListener('click', () => setViewMode('ytd'));
            viewAllBtn.addEventListener('click', () => setViewMode('all'));
            chatbotToggle.addEventListener('click', () => {
                chatbotWindow.classList.toggle('hidden');
                setTimeout(() => {
                    chatbotWindow.classList.toggle('scale-0');
                    chatbotWindow.classList.toggle('opacity-0');
                }, 10);
            });
            chatSend.addEventListener('click', handleChatSubmit);
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleChatSubmit();
            });
        }

        function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }

        function handleFiles(files) {
            uploadedFiles = Array.from(files).filter(file => file.type === 'application/pdf');
            updateFileList();
            analyzeButton.disabled = uploadedFiles.length === 0;
        }

        function updateFileList() {
            fileList.innerHTML = '';
            if (uploadedFiles.length > 0) {
                const list = document.createElement('ul');
                list.className = 'list-disc pl-5 space-y-1';
                uploadedFiles.forEach(file => {
                    const listItem = document.createElement('li');
                    listItem.textContent = `${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
                    list.appendChild(listItem);
                });
                fileList.appendChild(list);
            }
        }

        // --- CORE PROCESSING LOGIC ---
        async function processFiles() {
            if (uploadedFiles.length === 0) return showError("Please upload at least one PDF file.");
            
            showStatus("Reading and encoding files...");
            
            const filePromises = uploadedFiles.map(file => new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve({ inlineData: { mimeType: file.type, data: reader.result.split(',')[1] } });
                reader.onerror = reject;
                reader.readAsDataURL(file);
            }));

            try {
                const fileParts = await Promise.all(filePromises);
                showStatus("Sending documents to Gemini 2.5 Pro for analysis...");
                const newAnalysis = await getFinancialAnalysis(fileParts);
                
                showStatus("Merging new data with historical records...");
                const mergedData = mergeFinancialData(currentData, newAnalysis);
                
                showStatus("Analysis complete. Saving to database...");
                await saveData(mergedData);
                
                uploadSection.classList.add('hidden');
                
            } catch (e) {
                console.error("Processing error:", e);
                showError(`An error occurred during processing: ${e.message}`);
            }
        }

        // --- GEMINI API INTERACTION ---
        async function getFinancialAnalysis(fileParts) {
            const prompt = `
                You are an expert financial analyst. Analyze the provided financial documents (Income Statement, Balance Sheet, and optionally a Shipments by Product report).
                Extract the key financial data. Your response MUST be a single, valid JSON object.
                
                The JSON object must conform to this schema:
                {
                  "monthlyData": [ { "month": "Month Year", "revenue": 12345.67, "costOfSales": 1234.56, "costOfGoodsSold": 1234.56, "otherExpenses": 123.45, "netProfit": 123.45 } ],
                  "ytdTotals": { "revenue": 123456.78, "netProfit": 12345.67 },
                  "financialPosition": { "totalAssets": 123456.78, "totalLiabilities": 12345.67, "totalEquity": 12345.67, "currentAssets": 12345.67, "currentLiabilities": 1234.56 },
                  "detailedCostOfSales": [ { "category": "Expense Name", "value": 12345.67 } ],
                  "detailedOtherExpenses": [ { "category": "Expense Name", "value": 12345.67 } ],
                  "productPerformance": [ { "rangeName": "Product Name", "sales": 12345.67, "cost": 1234.56 } ],
                  "aiAnalysis": "A concise, professional summary of the company's performance for the LATEST period provided, highlighting key trends, strengths, weaknesses, and actionable recommendations."
                }

                Extract data for all available months in the documents. For detailed breakdowns and product performance, provide the Year-to-Date (YTD) cumulative totals from the latest report. If a product performance report is not provided, return an empty array for "productPerformance".
            `;

            const requestBody = {
                contents: [{ parts: [{ text: prompt }, ...fileParts] }],
                generationConfig: { responseMimeType: "application/json" }
            };
            
            const apiKey = "AIzaSyC-yMxXO1HXwrRsN4Xz71363ul5HHtgxXA"; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-pro:generateContent?key=${apiKey}`;

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) throw new Error(`API request failed with status ${response.status}`);
            const result = await response.json();
            
            if (result.candidates?.[0]?.content?.parts?.[0]) {
                return JSON.parse(result.candidates[0].content.parts[0].text);
            } else {
                throw new Error("Invalid response structure from Gemini API.");
            }
        }
        
        // --- DATA MERGING LOGIC ---
        function mergeFinancialData(existingData, newData) {
            if (!existingData || !existingData.monthlyData) return newData;
            
            const mergedMonthlyData = new Map(existingData.monthlyData.map(item => [item.month, item]));
            newData.monthlyData.forEach(item => mergedMonthlyData.set(item.month, item));
            const sortedMonthlyData = Array.from(mergedMonthlyData.values()).sort((a, b) => parseMonthYear(a.month) - parseMonthYear(b.month));

            return {
                monthlyData: sortedMonthlyData,
                ytdTotals: newData.ytdTotals,
                financialPosition: newData.financialPosition,
                aiAnalysis: newData.aiAnalysis,
                detailedCostOfSales: newData.detailedCostOfSales,
                detailedOtherExpenses: newData.detailedOtherExpenses,
                productPerformance: newData.productPerformance && newData.productPerformance.length > 0 ? newData.productPerformance : existingData.productPerformance
            };
        }

        // --- FIRESTORE DATA MANAGEMENT ---
        async function setupRealtimeListener() {
            const docRef = doc(db, `artifacts/${appId}/public/data/dashboard/latest`);
            
            onSnapshot(docRef, (docSnap) => {
                statusSection.classList.add('hidden');
                if (docSnap.exists()) {
                    currentData = docSnap.data().analysis;
                    setViewMode('ytd');
                    dashboardSection.classList.remove('hidden');
                } else {
                    currentData = null;
                    dashboardSection.classList.add('hidden');
                    uploadSection.classList.remove('hidden');
                }
            }, (error) => {
                console.error("Firestore listener error:", error);
                if (error.code === 'permission-denied') {
                    const errorMessage = `Firestore Permission Error: The application is not allowed to access the database.
                    \nThis is likely due to incorrect Firestore Security Rules. Please go to your Firebase Console -> Firestore Database -> Rules tab and ensure they are set to allow public access.
                    \nThe correct rules for a public dashboard are:
                    \nrules_version = '2';
                    service cloud.firestore {
                      match /databases/{database}/documents {
                        match /artifacts/{appId}/public/data/dashboard/{document=**} {
                          allow read, write: if request.auth != null;
                        }
                      }
                    }`;
                    showError(errorMessage);
                } else {
                    showError("Could not listen for data updates.");
                }
            });
        }

        async function saveData(analysisData) {
            const docRef = doc(db, `artifacts/${appId}/public/data/dashboard/latest`);
            await setDoc(docRef, { analysis: analysisData, lastUpdated: new Date() });
        }

        // --- DASHBOARD RENDERING ---
        function destroyAllCharts() {
            Object.values(chartInstances).forEach(chart => chart.destroy());
            chartInstances = {};
        }

        function setViewMode(mode) {
            currentViewMode = mode;
            viewYtdBtn.classList.toggle('bg-indigo-600', mode === 'ytd');
            viewYtdBtn.classList.toggle('text-white', mode === 'ytd');
            viewAllBtn.classList.toggle('bg-indigo-600', mode === 'all');
            viewAllBtn.classList.toggle('text-white', mode === 'all');
            if (currentData) renderDashboard(currentData);
        }

        // --- DATE & FINANCIAL YEAR LOGIC ---
        function parseMonthYear(monthYearStr) {
            if (!monthYearStr) return null;
            const parts = monthYearStr.split(' ');
            if (parts.length !== 2) return null;
            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            const monthIndex = monthNames.findIndex(m => m.toLowerCase().startsWith(parts[0].toLowerCase()));
            if (monthIndex === -1) return null;
            const year = parseInt(parts[1], 10);
            if (isNaN(year)) return null;
            return new Date(Date.UTC(year, monthIndex, 1));
        }

        function getFinancialYearStartYear(date = new Date()) {
            const month = date.getUTCMonth(); // 0-11
            const year = date.getUTCFullYear();
            return month < 2 ? year - 1 : year; // Financial year starts in March (month 2)
        }

        function getFinancialYearData(allData) {
            if (!allData || allData.length === 0) return [];
            
            const currentFYStartYear = getFinancialYearStartYear();
            const fyStartDate = new Date(Date.UTC(currentFYStartYear, 2, 1));

            return allData.filter(d => {
                const itemDate = parseMonthYear(d.month);
                return itemDate && !isNaN(itemDate) && itemDate >= fyStartDate;
            });
        }

        function renderDashboard(fullData) {
            destroyAllCharts();
            errorSection.classList.add('hidden');

            const isYtdView = currentViewMode === 'ytd';
            const dataForView = isYtdView ? getFinancialYearData(fullData.monthlyData) : fullData.monthlyData;
            
            const ytdDataForTitle = getFinancialYearData(fullData.monthlyData);
            const startYear = ytdDataForTitle.length > 0 ? parseMonthYear(ytdDataForTitle[0].month).getUTCFullYear() : getFinancialYearStartYear();
            
            dashboardTitle.textContent = `Dashboard & Analysis (${isYtdView ? `FY ${startYear + 1} YTD` : 'All Time'})`;

            // Calculate totals for the current view
            const totalRevenueForView = dataForView.reduce((sum, item) => sum + item.revenue, 0);
            const totalProfitForView = dataForView.reduce((sum, item) => sum + item.netProfit, 0);
            const totalCOGSForView = dataForView.reduce((sum, item) => sum + item.costOfGoodsSold, 0);
            
            const marginForView = (totalRevenueForView > 0) ? (totalProfitForView / totalRevenueForView) * 100 : 0;
            const materialCostPercForView = (totalRevenueForView > 0) ? (totalCOGSForView / totalRevenueForView) * 100 : 0;

            // Update KPIs
            document.getElementById('kpi-projected-profit').textContent = `R${calculateProjectedProfit().toLocaleString('en-ZA', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            document.getElementById('kpi-ytd-profit').textContent = `R${totalProfitForView.toLocaleString('en-ZA', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            document.getElementById('kpi-ytd-margin').textContent = `${marginForView.toFixed(2)}%`;
            document.getElementById('kpi-current-ratio').textContent = (fullData.financialPosition.currentLiabilities > 0) ? (fullData.financialPosition.currentAssets / fullData.financialPosition.currentLiabilities).toFixed(2) : '0.00';
            document.getElementById('ai-analysis').textContent = fullData.aiAnalysis;
            
            renderHealthDashboard(fullData);
            renderKpiProgressBars(fullData, totalProfitForView, marginForView, materialCostPercForView);

            const labels = dataForView.map(d => d.month);
            
            chartInstances.netProfitChart = new Chart(document.getElementById('netProfitChart'), { type: 'line', data: { labels, datasets: [{ label: 'Net Profit', data: dataForView.map(d => d.netProfit), borderColor: '#4f46e5', backgroundColor: 'rgba(79, 70, 229, 0.1)', fill: true, tension: 0.3 }] }, options: getChartOptions(true) });
            chartInstances.revenueVsCostChart = new Chart(document.getElementById('revenueVsCostChart'), { type: 'bar', data: { labels, datasets: [{ label: 'Total Revenue', data: dataForView.map(d => d.revenue), backgroundColor: 'rgba(16, 185, 129, 0.7)' }, { label: 'Total Costs', data: dataForView.map(d => d.costOfSales + d.otherExpenses), backgroundColor: 'rgba(239, 68, 68, 0.7)' }] }, options: getChartOptions(true) });
            
            renderDetailedCharts(fullData);
        }
        
        function renderHealthDashboard(data) {
            const latestMonth = data.monthlyData[data.monthlyData.length - 1];
            if (!latestMonth) return;

            document.getElementById('latest-month-label').textContent = latestMonth.month;

            const avgMonthlyProfitTarget = targets.annualProfit / 12;
            const latestMonthProfitMargin = (latestMonth.revenue > 0) ? (latestMonth.netProfit / latestMonth.revenue) * 100 : 0;
            const latestMonthMaterialCostPerc = (latestMonth.revenue > 0) ? (latestMonth.costOfGoodsSold / latestMonth.revenue) * 100 : 0;

            const ytdData = getFinancialYearData(data.monthlyData);
            const ytdTotalRevenue = ytdData.reduce((s, i) => s + i.revenue, 0);
            const ytdTotalProfit = ytdData.reduce((s, i) => s + i.netProfit, 0);
            const ytdTotalCOGS = ytdData.reduce((s, i) => s + i.costOfGoodsSold, 0);
            
            const ytdProfitMargin = (ytdTotalRevenue > 0) ? (ytdTotalProfit / ytdTotalRevenue) * 100 : 0;
            const ytdMaterialCostPerc = (ytdTotalRevenue > 0) ? (ytdTotalCOGS / ytdTotalRevenue) * 100 : 0;

            const monthProfitStatus = getPerformanceStatus(latestMonth.netProfit, avgMonthlyProfitTarget);
            const monthMarginStatus = getPerformanceStatus(latestMonthProfitMargin, targets.profitMargin);
            const monthMaterialStatus = getPerformanceStatus(latestMonthMaterialCostPerc, targets.materialCostPercentage, true);

            const ytdMarginStatus = getPerformanceStatus(ytdProfitMargin, targets.profitMargin);
            const ytdMaterialStatus = getPerformanceStatus(ytdMaterialCostPerc, targets.materialCostPercentage, true);
            
            updateCard('current-month', [monthProfitStatus, monthMarginStatus, monthMaterialStatus]);
            document.getElementById('current-month-profit-status').textContent = monthProfitStatus.text;
            document.getElementById('current-month-profit-status').className = `font-medium ${monthProfitStatus.textColorClass}`;
            document.getElementById('current-month-margin-status').textContent = monthMarginStatus.text;
            document.getElementById('current-month-margin-status').className = `font-medium ${monthMarginStatus.textColorClass}`;
            document.getElementById('current-month-material-cost-status').textContent = monthMaterialStatus.text;
            document.getElementById('current-month-material-cost-status').className = `font-medium ${monthMaterialStatus.textColorClass}`;

            updateCard('ytd', [ytdMarginStatus, ytdMaterialStatus]);
            document.getElementById('ytd-margin-status').textContent = ytdMarginStatus.text;
            document.getElementById('ytd-margin-status').className = `font-medium ${ytdMarginStatus.textColorClass}`;
            document.getElementById('ytd-material-cost-status').textContent = ytdMaterialStatus.text;
            document.getElementById('ytd-material-cost-status').className = `font-medium ${ytdMaterialStatus.textColorClass}`;
        }
        
        function renderKpiProgressBars(fullData, ytdProfit, ytdMargin, ytdMaterialCostPerc) {
            // Annual Target Progress
            const progressPercentage = (ytdProfit / targets.annualProfit) * 100;
            document.getElementById('progress-percentage').textContent = `${progressPercentage.toFixed(1)}%`;
            document.getElementById('progress-bar').style.width = `${Math.min(progressPercentage, 100)}%`;
            document.getElementById('kpi-target-profit').textContent = `R${targets.annualProfit.toLocaleString('en-ZA')}`;

            // Profit Margin Bar
            const marginIndicatorEl = document.getElementById('margin-indicator');
            const marginBarEl = document.getElementById('margin-bar');
            if (ytdMargin >= targets.profitMargin) {
                marginIndicatorEl.textContent = 'Above Target'; marginIndicatorEl.className = 'font-semibold text-teal-600';
                marginBarEl.className = 'h-3 rounded-full bg-teal-500';
            } else {
                marginIndicatorEl.textContent = 'Below Target'; marginIndicatorEl.className = 'font-semibold text-red-600';
                marginBarEl.className = 'h-3 rounded-full bg-red-500';
            }
            const marginScaleMaxVisual = Math.max(ytdMargin, targets.profitMargin, 15) * 1.2; 
            marginBarEl.style.width = `${(ytdMargin / marginScaleMaxVisual) * 100}%`;
            document.getElementById('margin-target-line').style.left = `${(targets.profitMargin / marginScaleMaxVisual) * 100}%`;
            document.getElementById('kpi-margin-target').textContent = `${targets.profitMargin.toFixed(2)}%`;

            // Material Cost Bar
            const materialCostIndicatorEl = document.getElementById('material-cost-indicator');
            const materialCostBarEl = document.getElementById('material-cost-bar');
            if (ytdMaterialCostPerc <= targets.materialCostPercentage) { 
                materialCostIndicatorEl.textContent = 'Below Target'; materialCostIndicatorEl.className = 'font-semibold text-green-600';
                materialCostBarEl.className = 'h-3 rounded-full bg-green-500';
            } else { 
                materialCostIndicatorEl.textContent = 'Above Target'; materialCostIndicatorEl.className = 'font-semibold text-red-600';
                materialCostBarEl.className = 'h-3 rounded-full bg-red-500';
            }
            const materialCostScaleMaxVisual = Math.max(ytdMaterialCostPerc, targets.materialCostPercentage) * 1.2;
            materialCostBarEl.style.width = `${(ytdMaterialCostPerc / materialCostScaleMaxVisual) * 100}%`;
            document.getElementById('material-cost-target-line').style.left = `${(targets.materialCostPercentage / materialCostScaleMaxVisual) * 100}%`;
            document.getElementById('kpi-material-cost-target').textContent = `${targets.materialCostPercentage.toFixed(2)}%`;
        }

        function renderDetailedCharts(data) {
            const totalCoS = data.detailedCostOfSales.reduce((sum, item) => sum + item.value, 0);
            const totalOpEx = data.detailedOtherExpenses.reduce((sum, item) => sum + item.value, 0);

            chartInstances.overallCostStructureChart = new Chart(document.getElementById('overallCostStructureChart'), { type: 'doughnut', data: { labels: ['Total Cost of Sales', 'Total Other Expenses'], datasets: [{ data: [totalCoS, totalOpEx], backgroundColor: ['#8b5cf6', '#d946ef'], hoverOffset: 8 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' }, datalabels: { formatter: (value, ctx) => { let sum = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0); return (value * 100 / sum).toFixed(1) + "%"; }, color: '#fff' } } } });
        
            renderHorizontalBarChart('detailedCostOfSalesChart', data.detailedCostOfSales, totalCoS, 150000);
            renderHorizontalBarChart('detailedOtherExpensesChart', data.detailedOtherExpenses, totalOpEx, 100000);

            if (data.productPerformance && data.productPerformance.length > 0) {
                renderProductPerformanceChart(data.productPerformance);
            }
        }
        
        function renderProductPerformanceChart(productData) {
            const sortedData = productData.map(item => ({ ...item, costPercentage: item.sales > 0 ? (item.cost / item.sales) * 100 : 0 })).sort((a,b) => b.costPercentage - a.costPercentage);
            const labels = sortedData.map(p => p.rangeName);
            const values = sortedData.map(p => p.costPercentage);
            const backgroundColors = values.map(p => {
                if (p > (targets.materialCostPercentage * 1.15)) return 'rgba(239, 68, 68, 0.7)';
                if (p > targets.materialCostPercentage) return 'rgba(249, 115, 22, 0.7)';
                return 'rgba(34, 197, 94, 0.7)';
            });
            const options = { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, datalabels: { anchor: 'end', align: 'end', formatter: (val) => `${val.toFixed(1)}%`, color: '#374151', font: { size: 9 } } }, scales: { x: { ticks: { callback: (value) => `${value}%` } } } };
            chartInstances.productRangeChart = new Chart(document.getElementById('productRangeChart'), { type: 'bar', data: { labels, datasets: [{ data: values, backgroundColor: backgroundColors }] }, options });
        }

        function renderHorizontalBarChart(canvasId, rawData, totalValue, threshold) {
            let mainItems = [];
            let otherTotal = 0;
            rawData.forEach(item => {
                if (Math.abs(item.value) >= threshold) mainItems.push(item);
                else otherTotal += item.value;
            });
            if (otherTotal !== 0) mainItems.push({ category: `Other Misc. Items`, value: otherTotal });
            mainItems.sort((a, b) => Math.abs(b.value) - Math.abs(a.value));

            const labels = mainItems.map(item => item.category);
            const values = mainItems.map(item => item.value);

            const options = { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, datalabels: { anchor: 'end', align: (ctx) => ctx.dataset.data[ctx.dataIndex] >= 0 ? 'end' : 'start', formatter: (val) => `${(val / totalValue * 100).toFixed(1)}%`, color: (ctx) => ctx.dataset.data[ctx.dataIndex] >= 0 ? '#374151' : '#b91c1c', font: { size: 9, weight: '500' } } }, scales: { x: { ticks: { callback: (value) => `R${(value / 1000000).toFixed(1)}M` } } } };
            chartInstances[canvasId] = new Chart(document.getElementById(canvasId), { type: 'bar', data: { labels, datasets: [{ data: values, backgroundColor: (ctx) => ctx.raw >= 0 ? 'rgba(59, 130, 246, 0.7)' : 'rgba(239, 68, 68, 0.6)' }] }, options });
        }

        function getPerformanceStatus(value, target, lowerIsBetter = false) {
            const ratio = value / target;
            let status, text;
            if (lowerIsBetter) {
                if (value <= target) status = 'green';
                else if (value <= target * 1.05) status = 'orange';
                else status = 'red';
                text = `${value.toFixed(2)}% vs ${target.toFixed(2)}%`;
            } else {
                if (ratio >= 1) status = 'green';
                else if (ratio >= 0.9) status = 'orange';
                else status = 'red';
                text = `${(ratio * 100).toFixed(0)}% of target`;
            }
            const colorMap = { green: 'text-green-700', orange: 'text-orange-700', red: 'text-red-700' };
            return { status, text, textColorClass: colorMap[status] };
        }

        function updateCard(prefix, statuses) {
            const indicator = document.getElementById(`${prefix}-health-indicator`);
            const textEl = document.getElementById(`${prefix}-health-text`);
            const colorMap = { green: 'bg-green-500', orange: 'bg-orange-500', red: 'bg-red-500' };
            const textMap = { green: 'On Track', orange: 'Caution', red: 'Below Target' };
            let finalStatus = 'green';
            if (statuses.some(s => s.status === 'red')) finalStatus = 'red';
            else if (statuses.some(s => s.status === 'orange')) finalStatus = 'orange';
            indicator.className = `w-8 h-8 rounded-full mr-4 ${colorMap[finalStatus]}`;
            textEl.textContent = textMap[finalStatus];
            textEl.className = `text-xl font-semibold ${statuses[0].textColorClass.replace('bg-', 'text-')}`;
        }

        function getChartOptions(isCurrency = false) {
            return { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' }, tooltip: { callbacks: { label: (ctx) => `${ctx.dataset.label || ''}: ${isCurrency ? `R${ctx.parsed.y.toLocaleString('en-ZA')}` : ctx.parsed.y}` } } }, scales: { y: { beginAtZero: true, ticks: { callback: (val) => isCurrency ? (val >= 1000000 ? `R${val / 1000000}M` : `R${val / 1000}K`) : val } } } };
        }
        
        function calculateProjectedProfit() {
            let profitGrowthRates = [];
            const years = Object.keys(historicalAnnualData).sort();
            for (let i = 1; i < years.length; i++) {
                const prevYear = historicalAnnualData[years[i-1]];
                const currentYear = historicalAnnualData[years[i]];
                if (prevYear.netProfit && currentYear.netProfit) {
                    profitGrowthRates.push((currentYear.netProfit - prevYear.netProfit) / prevYear.netProfit);
                }
            }
            const averageProfitGrowthRate = profitGrowthRates.length > 0 ? profitGrowthRates.reduce((a, b) => a + b, 0) / profitGrowthRates.length : 0.05;
            const lastYearProfit = historicalAnnualData[years[years.length - 1]].netProfit;
            return lastYearProfit * (1 + averageProfitGrowthRate);
        }

        // --- CHATBOT FUNCTIONS ---
        async function handleChatSubmit() {
            const userQuery = chatInput.value.trim();
            if (!userQuery || !currentData) return;

            addChatMessage(userQuery, 'user');
            chatInput.value = '';
            
            const botMessageDiv = addChatMessage('...', 'bot');
            
            try {
                const prompt = `You are a helpful financial assistant. The user's financial data is provided below in JSON format. Answer the user's question based ONLY on this data. Perform calculations if necessary. Be concise and clear. Data: ${JSON.stringify(currentData)}. Question: ${userQuery}`;
                
                const requestBody = { contents: [{ parts: [{ text: prompt }] }] };
                const apiKey = "AIzaSyC-yMxXO1HXwrRsN4Xz71363ul5HHtgxXA"; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-pro:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) throw new Error(`API request failed with status ${response.status}`);
                const result = await response.json();
                const botResponse = result.candidates?.[0]?.content?.parts?.[0]?.text || "Sorry, I couldn't process that.";
                
                botMessageDiv.textContent = botResponse;

            } catch (e) {
                console.error("Chatbot error:", e);
                botMessageDiv.textContent = "Sorry, an error occurred while getting your answer.";
            }
        }

        function addChatMessage(text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender}-message`;
            messageDiv.textContent = text;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            return messageDiv;
        }

        // --- UTILITY FUNCTIONS ---
        function showStatus(message) {
            statusSection.classList.remove('hidden');
            dashboardSection.classList.add('hidden');
            errorSection.classList.add('hidden');
            loader.classList.remove('hidden');
            statusText.textContent = message;
        }

        function showError(message) {
            statusSection.classList.add('hidden');
            errorSection.classList.remove('hidden');
            errorText.textContent = message;
        }

        setupUIHandlers();
        initialize();

    </script>
</body>
</html>
